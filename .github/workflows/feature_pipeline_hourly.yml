name: Feature Ingestion Pipeline

on:
  schedule:
    - cron: '0 * * * *'  #  Runs every hour (UTC)
  workflow_dispatch:       # Manual trigger if needed

jobs:
  update_features:
    runs-on: ubuntu-latest
    # The repository stores multiple secrets in a single secret named AQIDASHBOARD
    # We unpack that JSON blob at runtime into environment variables for later steps.
    env:
      SECRET_JSON: ${{ secrets.AQIDASHBOARD }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Unpack AQIDASHBOARD secret (raw)
        # Treat the AQIDASHBOARD secret as a raw single-value secret.
        # Export it as AQIDASHBOARD_RAW and, for compatibility, set
        # HOPSWORKS_API_KEY to the same value unless HOPSWORKS_API_KEY
        # was already provided separately.
        run: |
          if [ -z "$SECRET_JSON" ]; then
            echo "No AQIDASHBOARD secret provided; continuing without secret-based env vars"
            exit 0
          fi
          # Export the raw secret for downstream steps
          echo "AQIDASHBOARD_RAW=$SECRET_JSON" >> $GITHUB_ENV
          # If HOPSWORKS_API_KEY is not set, map it from the raw secret
          if [ -z "${HOPSWORKS_API_KEY:-}" ]; then
            echo "HOPSWORKS_API_KEY=$SECRET_JSON" >> $GITHUB_ENV
            echo "Mapped AQIDASHBOARD -> HOPSWORKS_API_KEY"
          else
            echo "HOPSWORKS_API_KEY already set; not overwriting"
          fi

      - name: Install dependencies (CI-safe)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then pip install -r requirements-ci.txt; else pip install pyarrow pandas joblib matplotlib seaborn statsmodels; fi

      - name: Install hopsworks (optional)
        run: |
          # Install hopsworks only if HOPSWORKS_API_KEY is available (unpacked from AQIDASHBOARD)
          if [ -n "${HOPSWORKS_API_KEY:-}" ]; then
            python -m pip install --upgrade pip
            pip install "hopsworks==4.2.*"
          else
            echo "HOPSWORKS_API_KEY not set; skipping hopsworks install"
          fi

      - name: Run feature ingestion script
        run: |
          # If the secret provided OPENWEATHER/other keys, they are available as env vars now.
          # Adjust the invocation and flags here as needed.
          python scripts/feature_pipeline.py --lat 24.86 --lon 67.00
